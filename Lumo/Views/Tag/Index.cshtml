@using Microsoft.AspNetCore.Mvc.Localization
@inject IViewLocalizer Localizer
@{
    ViewData["Title"] = Localizer["ManageTagsTitle"];
}

<div class="container mt-5">
    <h2 class="mb-4 text-center">@Localizer["ManageTagsTitle"] 🏷️</h2>

    <div class="card mb-4 shadow-sm">
        <div class="card-header" style="background-color: var(--secondary-color); color: #FFF;">
            @Localizer["AddNewTag"]
        </div>
        <div class="card-body">
            <form id="createTagForm">
                <div class="mb-3">
                    <label for="customName" class="form-label">@Localizer["TagNameLabel"]</label>
                    <input type="text" class="form-control" id="customName" placeholder="@Localizer["TagNamePlaceholder"]" required>
                </div>
                <button type="submit" class="btn btn-success">@Localizer["AddTagBtn"]</button>
            </form>
        </div>
    </div>

    <div class="card shadow-sm"
         id="tagsTableContainer"
         data-confirm-delete="@Localizer["ConfirmDeleteTag"]"
         data-error-create="@Localizer["ErrorCreateTag"]"
         data-error-delete="@Localizer["ErrorDeleteTag"]"
         data-badge-global="@Localizer["GlobalBadge"]"
         data-btn-delete="@Localizer["DeleteBtn"]">
        <div class="card-header" style="background-color: var(--secondary-color); color: #FFF;">
            @Localizer["ExistingTags"]
        </div>
        <div class="card-body">
            <ul id="tagsList" class="list-group"></ul>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        function loadTags() {
            const $container = $('#tagsTableContainer');
            const globalBadgeText = $container.data('badge-global');
            const deleteBtnText = $container.data('btn-delete');

            $.get('/api/tag', function(tags) {
                var $list = $('#tagsList');
                $list.empty();

                tags.forEach(t => {
                    const tagName = t.customName || t.resourceKey;
                    var listItem = `
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            ${tagName} ${t.isGlobal ? `<span class="badge bg-info text-dark">${globalBadgeText}</span>` : ''}
                            ${t.isGlobal ? '' : `<button class="btn btn-sm btn-danger delete-btn" data-id="${t.id}">${deleteBtnText}</button>`}
                        </li>`;
                    $list.append(listItem);
                });
            });
        }

        $(document).ready(function() {
            loadTags();

            const $container = $('#tagsTableContainer');

            // Tworzenie tagu
            $('#createTagForm').on('submit', function(e) {
                e.preventDefault();
                var data = {
                    customName: $('#customName').val()
                };

                $.ajax({
                    url: '/api/tag',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(data),
                    success: function() {
                        $('#createTagForm')[0].reset();
                        loadTags();
                    },
                    error: function(err) {
                        alert($container.data('error-create') + ' ' + (err.responseJSON?.message || ''));
                    }
                });
            });

            // Usuwanie tagu
            $('#tagsList').on('click', '.delete-btn', function() {
                var id = $(this).data('id');
                if (!confirm($container.data('confirm-delete'))) return;

                $.ajax({
                    url: '/api/tag/' + id,
                    type: 'DELETE',
                    success: function() {
                        loadTags();
                    },
                    error: function() {
                        alert($container.data('error-delete'));
                    }
                });
            });
        });
    </script>
}