@model List<Lumo.Models.DiaryEntry>

@{
    ViewData["Title"] = "Diary";
}

<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet" />

<div class="container mt-5">
    <h2 class="mb-4 text-center">My Diary 📖</h2>

    <!-- Add New Entry Form -->
    <div class="card shadow-sm mb-5">
        <div class="card-header bg-primary text-white">
            Add New Entry
        </div>
        <div class="card-body">
            <form id="createEntryForm">
                <div class="mb-3">
                    <label for="title" class="form-label">Title</label>
                    <input type="text" class="form-control" id="title" placeholder="Entry title..." required>
                </div>
                <div class="mb-3">
                    <label for="content" class="form-label">Content</label>
                    <textarea class="form-control" id="content" rows="4" placeholder="Write your thoughts..." required></textarea>
                </div>
                <div class="mb-3">
                    <label for="tags" class="form-label">Tags</label>
                    <select id="tags" class="form-select" multiple>
                        <!-- Loaded dynamically -->
                    </select>
                </div>
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label for="entryDate" class="form-label">Date</label>
                        <input type="date" class="form-control" id="entryDate" value="@DateTime.Now.ToString("yyyy-MM-dd")">
                    </div>
                    <div class="col-md-6">
                        <label for="moodRating" class="form-label">Mood</label>
                        <select class="form-select" id="moodRating">
                            <option value="1">😢 Very Bad</option>
                            <option value="2">☹️ Bad</option>
                            <option value="3" selected>😐 Neutral</option>
                            <option value="4">🙂 Good</option>
                            <option value="5">😄 Excellent</option>
                        </select>
                    </div>
                </div>
                <button type="submit" class="btn btn-success w-100">Add Entry</button>
            </form>
        </div>
    </div>

    <h3 class="mb-3">Diary Calendar</h3>
    <div id="calendar"></div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
    <script src="https://unpkg.com/@@popperjs/core@2/dist/umd/popper.min.js"></script>
    <script src="https://unpkg.com/tippy.js@6/dist/tippy-bundle.umd.min.js"></script>

    <script>
        // Load tags for the multi-select
        function loadTags() {
            $.get('/api/tag', function(tags) {
                var $select = $('#tags');
                $select.empty();
                tags.forEach(t => {
                    $select.append(`<option value="${t.id}">${t.customName}</option>`);
                });
            });
        }

        $(document).ready(function() {
            loadTags();

            // Handle diary entry creation
            $('#createEntryForm').on('submit', function(e) {
                e.preventDefault();

                var data = {
                    title: $('#title').val(),
                    content: $('#content').val(),
                    entryDate: $('#entryDate').val(),
                    moodRating: parseInt($('#moodRating').val()),
                    tagIds: $('#tags').val() || []
                };

                $.ajax({
                    url: '/api/diary',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(data),
        success: function(entry) {
            // Use the returned DTO
            var moodEmoji = '';
            var bgColor = '';
            switch(entry.moodRating) {
                case 1: moodEmoji = '😢'; bgColor = '#fee2e2'; break;
                case 2: moodEmoji = '☹️'; bgColor = '#fecaca'; break;
                case 3: moodEmoji = '😐'; bgColor = '#fef3c7'; break;
                case 4: moodEmoji = '🙂'; bgColor = '#d1fae5'; break;
                case 5: moodEmoji = '😄'; bgColor = '#bfdbfe'; break;
            }

            calendar.addEvent({
                id: entry.id,
                title: moodEmoji,
                start: entry.entryDate,
                allDay: true,
                backgroundColor: bgColor,
                borderColor: bgColor,
                textColor: '#111827',
                extendedProps: {
                    title: entry.title,
                    content: entry.content,
                    tags: entry.tags
                }
            });

            $('#createEntryForm')[0].reset();
            loadTags();
        }

                });
            });

            // Initialize FullCalendar
            var calendarEl = document.getElementById('calendar');
            var calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                headerToolbar: { left: 'prev,next today', center: 'title', right: '' },
                events: function(fetchInfo, successCallback) {
                    $.get('/api/diary', function(entries) {
                        var events = entries.map(function(e) {
                            var moodEmoji = '';
                            var bgColor = '';
                            switch(e.moodRating) {
                                case 1: moodEmoji = '😢'; bgColor = '#fee2e2'; break;
                                case 2: moodEmoji = '☹️'; bgColor = '#fecaca'; break;
                                case 3: moodEmoji = '😐'; bgColor = '#fef3c7'; break;
                                case 4: moodEmoji = '🙂'; bgColor = '#d1fae5'; break;
                                case 5: moodEmoji = '😄'; bgColor = '#bfdbfe'; break;
                            }
                            return {
                                id: e.id,
                                title: moodEmoji,
                                start: e.entryDate,
                                allDay: true,
                                backgroundColor: bgColor,
                                borderColor: bgColor,
                                textColor: '#111827',
                                extendedProps: {
                                    title: e.title,
                                    content: e.content,
                                    tags: e.tags // ✅ include tags
                                }
                            };
                        });
                        successCallback(events);
                    });
                },
                eventContent: function(arg) {
                    return {
                        html: `<div class="fc-event-custom">${arg.event.title}</div>`
                    };
                },
                eventDidMount: function(info) {
                    var tagsHtml = '';
                    if(info.event.extendedProps.tags) {
                        tagsHtml = info.event.extendedProps.tags
                            .map(t => `<span class="badge bg-secondary me-1">${t}</span>`)
                            .join('');
                    }

                    tippy(info.el, {
                        content: `<strong>${info.event.extendedProps.title}</strong><br>${info.event.extendedProps.content}<br>${tagsHtml}`,
                        allowHTML: true,
                        theme: 'light',
                        placement: 'top',
                    });
                }
            });

            calendar.render();
        });
    </script>

    <style>
        #calendar {
            background: white;
            border-radius: 1rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.05);
            padding: 1rem;
        }

        .fc-daygrid-day:hover {
            background: #f3f4f6;
        }

        /* Remove FullCalendar padding */
        .fc-event .fc-event-main-frame {
            padding: 0;
        }

        /* Fixed day height */
        .fc .fc-daygrid-day-frame {
            min-height: 100px;
            position: relative;
        }

        /* Mood emoji tile */
        .fc-event {
            padding: 5px;
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            color: #111827;
            font-size: 5rem;
            margin: 2px;
            pointer-events: auto;
            text-align: center;
            height: 100px;
        }
    </style>
}
