@model List<Lumo.Models.DiaryEntry>

@{
    ViewData["Title"] = "Diary";
}

<!-- Include FullCalendar CSS and JS -->
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>

<div class="container mt-5">
    <h2 class="mb-4 text-center">My Diary 📖</h2>

    <!-- Add New Entry Form -->
    <div class="card shadow-sm mb-5">
        <div class="card-header bg-primary text-white">
            Add New Entry
        </div>
        <div class="card-body">
            <form id="createEntryForm">
                <div class="mb-3">
                    <label for="title" class="form-label">Title</label>
                    <input type="text" class="form-control" id="title" placeholder="Entry title..." required>
                </div>
                <div class="mb-3">
                    <label for="content" class="form-label">Content</label>
                    <textarea class="form-control" id="content" rows="4" placeholder="Write your thoughts..." required></textarea>
                </div>
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label for="entryDate" class="form-label">Date</label>
                        <input type="date" class="form-control" id="entryDate" value="@DateTime.Now.ToString("yyyy-MM-dd")">
                    </div>
                    <div class="col-md-6">
                        <label for="moodRating" class="form-label">Mood</label>
                        <select class="form-select" id="moodRating">
                            <option value="1">😢 Very Bad</option>
                            <option value="2">☹️ Bad</option>
                            <option value="3" selected>😐 Neutral</option>
                            <option value="4">🙂 Good</option>
                            <option value="5">😄 Excellent</option>
                        </select>
                    </div>
                </div>
                <button type="submit" class="btn btn-success w-100">Add Entry</button>
            </form>
        </div>
    </div>

    <!-- Calendar -->
    <h3 class="mb-3">Diary Calendar</h3>
    <div id="calendar"></div>
</div>

@section Scripts {
    <script>
        $(function () {
            // Initialize FullCalendar with month view only
            var calendarEl = document.getElementById('calendar');
            var calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: '' // no week/day buttons
                },
                events: function(fetchInfo, successCallback) {
                    $.get('/api/diary', function(entries) {
                        var events = entries.map(function(e) {
                            var moodEmoji = '';
                            switch(e.moodRating) {
                                case 1: moodEmoji = '😢'; break;
                                case 2: moodEmoji = '☹️'; break;
                                case 3: moodEmoji = '😐'; break;
                                case 4: moodEmoji = '🙂'; break;
                                case 5: moodEmoji = '😄'; break;
                            }
                            return {
                                id: e.id,
                                title: `${moodEmoji} ${e.title}`,
                                start: e.entryDate,
                                extendedProps: { content: e.content }
                            };
                        });
                        successCallback(events);
                    });
                },
                eventClick: function(info) {
                    alert(info.event.title + "\n\n" + info.event.extendedProps.content);
                }
            });

            calendar.render();

            // Handle form submission
            $('#createEntryForm').submit(function(e) {
                e.preventDefault();
                var data = {
                    title: $('#title').val(),
                    content: $('#content').val(),
                    entryDate: $('#entryDate').val(),
                    tagIds: [],
                    moodRating: parseInt($('#moodRating').val()),
                    isFavorite: false
                };

                $.ajax({
                    url: '/api/diary',
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(data),
                    success: function() {
                        $('#createEntryForm')[0].reset();
                        $('#moodRating').val(3);
                        calendar.refetchEvents(); // Refresh calendar
                    },
                    error: function(err) {
                        console.error("ERROR", err);
                        alert('Check console for error details');
                    }
                });
            });
        });
    </script>
}
