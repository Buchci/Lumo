@model List<Lumo.Models.DiaryEntry>

@{
    ViewData["Title"] = "Diary";
}

<link rel="stylesheet" href="https://uicdn.toast.com/tui-calendar/latest/tui-calendar.css" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">

<div class="container mt-5">
    <h2 class="mb-4 text-center">My Diary 📖</h2>

    <!-- Add New Entry Form -->
    <div class="card shadow-sm mb-5">
        <div class="card-header bg-primary text-white">
            Add New Entry
        </div>
        <div class="card-body">
            <form id="createEntryForm">
                <div class="mb-3">
                    <label for="title" class="form-label">Title</label>
                    <input type="text" class="form-control" id="title" placeholder="Entry title..." required>
                </div>
                <div class="mb-3">
                    <label for="content" class="form-label">Content</label>
                    <textarea class="form-control" id="content" rows="4" placeholder="Write your thoughts..." required></textarea>
                </div>

                <div class="mb-3">
                    <label class="form-label">Tags</label>
                    <div id="tags" class="d-flex flex-wrap gap-2"></div>
                </div>

                <div class="row mb-3">
                    <div class="col-md-6">
                        <label for="entryDate" class="form-label">Date</label>
                        <input type="date" class="form-control" id="entryDate" value="@DateTime.Now.ToString("yyyy-MM-dd")">
                    </div>
                    <div class="col-md-6">
                        <label for="moodRating" class="form-label">Mood</label>
                        <select class="form-select" id="moodRating">
                            <option value="1">😢 Very Bad</option>
                            <option value="2">☹️ Bad</option>
                            <option value="3" selected>😐 Neutral</option>
                            <option value="4">🙂 Good</option>
                            <option value="5">😄 Excellent</option>
                        </select>
                    </div>
                </div>
                <button type="submit" class="btn btn-success w-100">Add Entry</button>
            </form>
        </div>
    </div>

    <h3 class="mb-3">Diary Calendar</h3>

    <!-- Month Navigation -->
    <div class="d-flex justify-content-between align-items-center mb-2">
        <div>
            <button id="prevMonth" class="btn btn-outline-primary">&lt; Prev</button>
            <button id="nextMonth" class="btn btn-outline-primary ms-2">Next &gt;</button>
            <button id="today" class="btn btn-outline-secondary ms-2">Today</button>
        </div>
        <h4 id="currentMonth" class="mb-0"></h4>
    </div>

    <div id="tui-calendar" style="height: 700px; border: 1px solid #ccc; border-radius: 8px;"></div>
</div>

<!-- Custom Modal for Entry Details -->
<div class="modal fade" id="entryModal" tabindex="-1" aria-labelledby="entryModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="entryModalTitle"></h5>
        <button type="button" class="btn-close" id="entryModalBtnClose" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p id="entryModalContent"></p>
        <div id="entryModalTags" class="mb-2"></div>
      </div>
      <div class="modal-footer">
        <button type="button" id="editEntryBtn" class="btn btn-primary">Edit</button>
        <button type="button" id="deleteEntryBtn" class="btn btn-danger">Delete</button>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

@section Scripts {
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://uicdn.toast.com/tui.code-snippet/latest/tui-code-snippet.min.js"></script>
<script src="https://uicdn.toast.com/tui.time-picker/latest/tui-time-picker.min.js"></script>
<script src="https://uicdn.toast.com/tui.date-picker/latest/tui-date-picker.min.js"></script>
<script src="https://uicdn.toast.com/tui-calendar/latest/tui-calendar.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
function loadTags() {
    $.get('/api/tag', function(tags) {
        var $container = $('#tags');
        $container.empty();
        tags.forEach(tag => {
            const checkboxHtml = `
                <div class="form-check me-3">
                    <input class="form-check-input tag-checkbox" type="checkbox" value="${tag.id}" id="tag_${tag.id}">
                    <label class="form-check-label" for="tag_${tag.id}">${tag.customName}</label>
                </div>
            `;
            $container.append(checkboxHtml);
        });
    });
}

$(document).ready(function() {
    loadTags();

    var calendar = new tui.Calendar('#tui-calendar', {
        defaultView: 'month',
        taskView: false,
        scheduleView: ['time', 'allday', 'milestone'],
        useCreationPopup: true,
        useDetailPopup: false,
        month: { startDayOfWeek: 1 }
    });

    function mapMoodToColor(mood) {
        switch(mood) {
            case 1: return '#fc6969';
            case 2: return '#ff8533';
            case 3: return '#fcdf69';
            case 4: return '#30e889';
            case 5: return '#33ffd6';
            default: return '#fef3c7';
        }
    }

    function loadEntries() {
        $.get('/api/diary', function(entries) {
            calendar.clear();
            const schedules = entries.map(e => {
                return {
                    id: String(e.id),
                    calendarId: '1',
                    title: e.title,
                    category: 'allday',
                    start: e.entryDate,
                    end: e.entryDate,
                    isAllDay: true,
                    bgColor: mapMoodToColor(e.moodRating),
                    color: '#111827',
                    raw: { content: e.content, tags: e.tags, moodRating: e.moodRating }
                };
            });
            calendar.createSchedules(schedules);
        });
    }

    loadEntries();

    $('#createEntryForm').on('submit', function(e) {
        e.preventDefault();
        const data = {
            title: $('#title').val(),
            content: $('#content').val(),
            entryDate: $('#entryDate').val(),
            moodRating: parseInt($('#moodRating').val()),
            tagIds: $('.tag-checkbox:checked').map(function() { return $(this).val(); }).get()
        };

        $.ajax({
            url: '/api/diary',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(data),
            success: function(entry) {
                calendar.createSchedules([{
                    id: String(entry.id),
                    calendarId: '1',
                    title: entry.title,
                    category: 'allday',
                    start: entry.entryDate,
                    end: entry.entryDate,
                    isAllDay: true,
                    bgColor: mapMoodToColor(entry.moodRating),
                    color: '#111827',
                    raw: { content: entry.content, tags: entry.tags }
                }]);
                $('#createEntryForm')[0].reset();
                loadTags();
            }
        });
    });

    function updateMonthLabel() {
        const current = calendar.getDate();
        const month = current.getMonth() + 1;
        const year = current.getFullYear();
        document.getElementById('currentMonth').innerText = `${year} / ${month}`;
    }

    updateMonthLabel();
    document.getElementById('prevMonth').addEventListener('click', function() { calendar.prev(); updateMonthLabel(); });
    document.getElementById('nextMonth').addEventListener('click', function() { calendar.next(); updateMonthLabel(); });
    document.getElementById('today').addEventListener('click', function() { calendar.today(); updateMonthLabel(); });

    calendar.on('clickSchedule', function(event) {
        const sch = event.schedule;
        $('#entryModalTitle').text(sch.title);
        $('#entryModalContent').text(sch.raw.content);
        $('#entryModalTags').html(
            sch.raw.tags?.map(t => `<span class="badge bg-secondary me-1">${t}</span>`).join('') || ''
        );

        var myModal = new bootstrap.Modal(document.getElementById('entryModal'));
        myModal.show();

        $('#editEntryBtn').off('click').on('click', function() {
            alert('Edit entry ' + sch.id);
        });

        $('#deleteEntryBtn').off('click').on('click', function() {
            if (confirm('Are you sure you want to delete this entry?')) {
                $.ajax({
                    url: '/api/diary/' + sch.id,
                    type: 'DELETE',
                    success: function() {
                        calendar.deleteSchedule(sch.id, sch.calendarId);
                        myModal.hide();
                    }
                });
            }
        });
    });
});
</script>

<style>
.tui-full-calendar-container {
    background: white;
    border-radius: 8px;
}
.tui-full-calendar-schedule {
    border-radius: 6px;
    padding: 3px 5px;
    font-size: 0.9rem;
}

/* Responsive modal for long content and tags */
#entryModal .modal-dialog {
    max-width: 500px;
}
#entryModalTitle {
    padding-left:15px;
    padding-right:15px;
}
#entryModalBtnClose {
    margin:10px;
}

#entryModal .modal-content {
    display: flex;
    flex-direction: column;
            padding-left: 15px;
            padding-right: 15px;
}

#entryModal .modal-body {
    overflow: visible;
    word-break: break-word;
    max-height: 50vh; /* optional: scroll if extremely long */
    overflow-y: auto;
}

#entryModalTitle {
    word-break: break-word;
}
</style>
}