@using Microsoft.AspNetCore.Mvc.Localization
@inject IViewLocalizer Localizer
@{
    ViewData["Title"] = Localizer["FavoritesTitle"];
}

<div class="container mt-5"
     id="favoritesPage"
     data-view-text="@Localizer["ViewBtn"]"
     data-confirm-delete="@Localizer["ConfirmDelete"]"
     data-error-delete="@Localizer["ErrorDelete"]"
     data-fav-badge="@Localizer["FavoriteBadge"]"
     data-not-fav-badge="@Localizer["NotFavoriteBadge"]">

    <div class="text-center mb-4">
        <h2>@Localizer["FavoritesHeader"]</h2>
        <p class="text-muted">@Localizer["FavoritesSubheader"]</p>
    </div>

    <div id="emptyState" class="text-center text-muted mt-5 d-none">
        <h5>@Localizer["EmptyStateTitle"]</h5>
        <p>@Localizer["EmptyStateText"]</p>
    </div>

    <div class="row" id="favoritesContainer"></div>

</div>

@await Html.PartialAsync("_EntryModal")

@section Scripts {
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <script>
        $(document).ready(function () {
            loadFavorites();
        });

        const $page = $('#favoritesPage');

        function moodEmoji(mood) {
            switch (mood) {
                case 1: return '😢';
                case 2: return '☹️';
                case 3: return '😐';
                case 4: return '🙂';
                case 5: return '😄';
                default: return '😐';
            }
        }

        function moodColor(mood) {
            switch (mood) {
                case 1: return '#fc6969';
                case 2: return '#ff8533';
                case 3: return '#fcdf69';
                case 4: return '#30e889';
                case 5: return '#33ffd6';
                default: return '#e5e7eb';
            }
        }

        function loadFavorites() {
            $.get('/api/diary/favorites', function (entries) {
                const $container = $('#favoritesContainer');
                const viewText = $page.data('view-text');
                $container.empty();

                if (!entries || entries.length === 0) {
                    $('#emptyState').removeClass('d-none');
                    return;
                }

                $('#emptyState').addClass('d-none');

                entries.forEach(e => {
                    $container.append(`
                        <div class="col-md-6 col-lg-4 mb-4">
                            <div class="card shadow-sm h-100 favorite-card"
                                 style="border-top: 5px solid ${moodColor(e.moodRating)}">
                                <div class="card-body d-flex flex-column">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <small class="text-muted">
                                            ${new Date(e.entryDate).toLocaleDateString()}
                                        </small>
                                        <span class="fs-4">${moodEmoji(e.moodRating)}</span>
                                    </div>
                                    <h5 class="card-title text-truncate">${e.title}</h5>
                                    <p class="card-text text-muted mb-3 content-preview">
                                        ${e.content}
                                    </p>
                                    <div class="mb-3">
                                        ${(e.tags || []).map(t =>
                                            `<span class="badge bg-secondary me-1 mb-1">${t}</span>`
                                        ).join('')}
                                    </div>
                                    <div class="mt-auto d-flex justify-content-end">
                                        <button class="btn-lumo btn-sm btn-outline-primary view-btn"
                                                data-entry='${JSON.stringify(e).replace(/'/g, "&apos;")}'>
                                            ${viewText}
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `);
                });
            });
        }

        $(document).on('click', '.view-btn', function () {
            const entry = JSON.parse($(this).attr('data-entry'));
            showEntryModal(entry);
        });

        function showEntryModal(entry) {
            $('#entryModalTitle').text(entry.title);
            $('#entryModalContent').text(entry.content);

            $('#entryModalTags').html(
                (entry.tags || []).map(t => `<span class="badge bg-secondary me-1">${t}</span>`).join('')
            );

            const favBadge = entry.isFavorite ?
                `<span class="text-warning">${$page.data('fav-badge')}</span>` :
                `<span class="text-muted">${$page.data('not-fav-badge')}</span>`;

            $('#entryModalFavorite').html(favBadge);

            $('#editEntryBtn').off('click').on('click', function() {
                window.location.href = '/Diary/Edit/' + entry.id;
            });

            $('#deleteEntryBtn').off('click').on('click', function() {
                if (confirm($page.data('confirm-delete'))) {
                    $.ajax({
                        url: '/api/diary/' + entry.id,
                        type: 'DELETE',
                        success: function() {
                            bootstrap.Modal.getInstance(document.getElementById('entryModal')).hide();
                            loadFavorites();
                        },
                        error: function() {
                            alert($page.data('error-delete'));
                        }
                    });
                }
            });

            const modal = new bootstrap.Modal(document.getElementById('entryModal'));
            modal.show();
        }
    </script>
}

<style>
    .favorite-card {
        transition: transform 0.15s ease, box-shadow 0.15s ease;
        cursor: default;
    }

        .favorite-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 24px rgba(0,0,0,0.12);
        }

    .content-preview {
        overflow: hidden;
        display: -webkit-box;
        -webkit-line-clamp: 3;
        -webkit-box-orient: vertical;
    }

    .badge {
        font-size: 0.75rem;
    }
</style>